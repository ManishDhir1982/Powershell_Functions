#Import the .csv File Data into a Variable
#*******Make Changes to the .xlsx File and then Save it as .csv File
$hstbl_Sheet_Data = E:\Data_Final\Reneeka\PS_Modules\fn_Load_CSV.ps1 -str_CSV_Path E:\Data_Final\Reneeka\Sheet_Generator.csv

#Group the .csv Data by School Level and Store into the Array
$arr_Unique_School_Levels = $script:hstbl_Sheet_Data | Group-Object -Property School_Level
#$arr_Unique_School_Levels
#$arr_Unique_School_Levels.Name.Count

#Group the .csv Data by Grade and Store into the Array
$arr_Unique_Grades = $script:hstbl_Sheet_Data | Group-Object -Property Grade
#$arr_Unique_Grades
#$arr_Unique_Grades.Name.Count

#Variable to Store User Input
[int]$int_User_Input

#Variable to Store User Selection : School Level
[string]$str_User_School_Level_Selection

#Variable to Store User Selection : Grade
[string]$str_User_Grade_Selection

#Variable to Store User Selection : Group
[int]$int_User_Group_Selection

#Variable to Store User Selection : Topic
[string]$str_User_Topic

#Variable to Store User Selection : Sub_Topic
[string]$str_User_Sub_Topic

#Used in SaveSHeet FUnction
[object[]]$obj_Final_URL = $null

$dt_Sheet_Start_Date = date("24-June-2022") -Format "dd-MMMM-yyyy" # Change the Date here

$dt_Date = Get-Date -Format "dd-MMMM-yyyy"
$outFileBaseFolder = "E:\Data_Final"
$int_Number_Of_Weeks = 12
$int_Number_of_Print

##########################################################
function fn_SaveSheets() {
    $int_Ctr_Days_Add=0
    $script:int_Number_of_Print = $script:int_Number_Of_Weeks * 7

    for ($i = 1; $i -le $script:int_Number_of_Print; $i++) {
        foreach ($temp_Object in $script:obj_Final_URL) {
        $str_SheetSource = $temp_Object.WebSite
        $str_Topic = $temp_Object.Topic
        $str_Sub_Topic = $temp_Object.Sub_Topic
        
        $script:dt_File_Name = (get-date ((get-date $script:dt_Sheet_Start_Date).AddDays($int_Ctr_Days_Add)) -Format "dd-MMMM-yyyy")
        $int_Ctr_Days_Add++

        $str_DestinationFolder = "$outFileBaseFolder\$script:str_User_School_Level_Selection\$script:str_User_Grade_Selection\$str_Topic\$str_Sub_Topic\$script:dt_Date"

        fn_Check_If_Path_Exists $str_DestinationFolder $true
        $script:outFilePath = "$str_DestinationFolder\$i-$script:dt_File_Name-$i.pdf"
        
        if ($str_SheetSource -eq "Math-Aids") {

            fn_MathAid $temp_Object.WebSite_URL
        } elseif ($str_SheetSource -eq "HomeSchoolMath") {
            $str_Temp_URL = $temp_Object.WebSite_URL
            $script:str_SheetURL = $str_Temp_URL.Replace("title=","title=`"$script:dt_File_Name`"")
            Invoke-WebRequest -URI $str_Temp_URL -OutFile $script:outFilePath
            #$script:str_SheetURL
        } elseif ($str_SheetSource -eq "MathFactCafe1") {
            $dbl_Random = (Get-Random -Maximum 9999999) -join ''
            $str_Temp_URL = $temp_Object.WebSite_URL
            $script:str_SheetURL = $str_Temp_URL.Replace("Seed=5078184","Seed=$dbl_Random")
            Invoke-WebRequest -URI $script:str_SheetURL -OutFile $script:outFilePath
        } elseif ($script:str_SheetSource -eq "MathFactCafe") {
            
            $dbl_Random = (Get-Random -Maximum 9999999) -join ''
            $str_Temp_URL = $temp_Object.WebSite_URL
            $script:str_SheetURL = $str_Temp_URL.Replace("Seed=5078184","Seed=$dbl_Random")
            $doc = Invoke-WebRequest -URI $script:str_SheetURL
            $div_MathCafe = $doc.ParsedHtml.getElementByID('worksheet-body')
            #$div_MathCafe.TextContent | Out-File "E:$i.txt"
            $div_WordProblems = $div_MathCafe.getElementsByTagName('div')
            $myProblems = "`t `t" + $script:dt_File_Name + "`r`n `r`n `r`n `r`n"
            foreach ($temp_WordProblem in $div_WordProblems) {
            if ($temp_WordProblem.ClassName -eq "wp-problem ") {
                $myProblems += $temp_WordProblem.TextContent + "`r`n `r`n `r`n"
                 
                }
            }
                $myProblems | Out-File $script:outFilePath.Replace("pdf","doc") -Encoding ascii
            }
            
        
        

    }
    }
    $script:int_Days_To_Add = 0

}
####################################
function fn_ReadInput {
    param(
    [parameter(Mandatory=$true)]
    [int]$in_int_Options_Count
    )

    #Do Loop to Capture Values between 1 and the Max
    Do {
        try {
            [int]$User_input = Read-Host "Please Enter your Selection# [ 1 to " $in_int_Options_Count "]"
            
            if (($User_input -le 0) -or ($User_input -gt $in_int_Options_Count)) {
                write-host "Input is not from the range"   
            }
        } catch {
            write-host "Input is not from the range"    
        }
    } Until (($User_input -ge 1) -and ($User_input -le ($in_int_Options_Count)))
    
    return $User_input
}

function fn_Write_Host_Options {
    param (
    [parameter(Mandatory=$true)]
    [object[]] $arr_Print_What,

    [parameter(Mandatory=$true)]
    [string]$str_Print_Title
    )

    #Variable to Give Serial Number to the Menu Options
    $int_SR = 1

    #Print the Title
    Write-Host "`n Select" $str_Print_Title':' -ForegroundColor Cyan

    #Print the Options
    $arr_Print_What | ForEach-Object {write-host `t $int_SR ">" $_ -ForegroundColor Green; $int_SR++}

    #Capture the User Input
    $script:int_User_Input = fn_ReadInput $arr_Print_What.Count

    }

fn_Write_Host_Options $arr_Unique_School_Levels.Name "School_Level"
$str_User_School_Level_Selection = $arr_Unique_School_Levels[$script:int_User_Input-1].Name

fn_Write_Host_Options $arr_Unique_Grades.Name "Grade"
$str_User_Grade_Selection = $arr_Unique_Grades[$script:int_User_Input-1].Name

#Get List of Groups Based on User Provided School Level and Grade
$arr_Unique_Groups = ""
$arr_Unique_Groups = $script:hstbl_Sheet_Data | where {($_.School_Level -eq $str_User_School_Level_Selection) -and ($_.Grade -eq $str_User_Grade_Selection)} | Select-Object * | Group-Object -Property Member_Of_Group

#Grab All the Data from the CSV Based on the the 3 Criteria School_Level, Grade and Member_Of_Group
#Print the Groups, Topics and Sub-Topics
[int]$int_Group_SR = 1
[int]$int_Sub_Topic_SR = 1
[object[]]$arr_Final_All_Data = $null
foreach ($temp_Group in $arr_Unique_Groups.Name) {
    Write-Host "Group#[$script:int_Group_SR] $temp_Group": -ForegroundColor Cyan
    $script:arr_Final_All_Data = $script:hstbl_Sheet_Data | where {($_.School_Level -eq $str_User_School_Level_Selection) -and ($_.Grade -eq $str_User_Grade_Selection) -and ($_.Member_Of_Group -eq $temp_Group)} | Select-Object *
    
    foreach ($temp_Final_Data in $script:arr_Final_All_Data) {
        $script:str_User_Topic = $temp_Final_Data.Topic
        $script:str_User_Sub_Topic = $temp_Final_Data.Sub_Topic
        write-host `t $int_Sub_Topic_SR ">" $temp_Final_Data.Topic "-" $temp_Final_Data.Sub_Topic -ForegroundColor Green
        $script:int_Sub_Topic_SR++
    }
    #Reset the Sub_Topic Counter to 1 On Group Change
    [int]$int_Sub_Topic_SR = 1
}
#$arr_Final_All_Data
#Capture the User Group Selection
$script:int_User_Input = fn_ReadInput $arr_Unique_Groups.Count
$script:int_User_Group_Selection = $arr_Unique_Groups.Name[$script:int_User_Input-1]

$script:obj_Final_URL = $script:hstbl_Sheet_Data | where {($_.School_Level -eq $str_User_School_Level_Selection) -and ($_.Grade -eq $str_User_Grade_Selection) -and ($_.Member_Of_Group -eq $script:int_User_Group_Selection)} | Select-Object *
#$script:obj_Final_URL
fn_SaveSheets



